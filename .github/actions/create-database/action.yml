name: "Create Turso Database"

description: "Automatically create a Turso database"

inputs:
  organization_name:
    description: "The name of the organization or account where this action will be performed."
    required: true
  api_token:
    description: "The API key that has access to the organization or account."
    required: true
  group_name:
    description: "The group name the database should be created in."
    required: false

outputs:
  hostname:
    description: "The database hostname without protocol."
    value: ${{ steps.create-database.outputs.hostname }}
  token:
    description: "The database token"
    value: ${{ steps.create-database.outputs.token }}

runs:
  using: "composite"
  steps:
    - name: Get Group
      id: get-group
      if: inputs.group_name == ''
      shell: bash
      run: |
        RESPONSE=$(curl -s -f \
          -H "Authorization: Bearer ${{ inputs.api_token }}" \
          "https://api.turso.tech/v1/organizations/${{ inputs.organization_name }}/databases/${{ inputs.existing_database_name }}")

        if [ $? -ne 0 ]; then
          echo "Could not fetch database"
          exit 1
        fi
        echo $RESPONSE
        GROUP_NAME=$(echo $RESPONSE | jq -r '.database.group')
        if [ -z "$GROUP_NAME" ]; then
          echo "Group name not found in response"
          exit 1
        fi

        echo "GROUP_NAME=$GROUP_NAME" >> $GITHUB_ENV
    - name: Create Database
      id: create-database
      shell: bash
      run: |
        if [ -z "${{ inputs.group_name }}" ]; then
          GROUP_TO_USE=$GROUP_NAME
        else
          GROUP_TO_USE="${{ inputs.group_name }}"
        fi

        RESPONSE=$(curl -s -f -X POST \
          -H "Authorization: Bearer ${{ inputs.api_token }}" \
          -H "Content-Type: application/json" \
          -d '{"name": "${{ github.ref_name }}", "group": "'"$GROUP_TO_USE"'" }' \
          "https://api.turso.tech/v1/organizations/${{ inputs.organization_name }}/databases")

        if [ $? -ne 0 ]; then
          echo "Could not create database"
          exit 1
        fi

        HOSTNAME=$(echo $RESPONSE | jq -r '.database.Hostname')
        if [ -z "$HOSTNAME" ]; then
          echo "Hostname not found in response"
          exit 1
        fi

        echo "hostname=libsql://$HOSTNAME" >> $GITHUB_OUTPUT
    - name: Create Token 
      id: create-token
      shell: bash
      run: |
        if [ -z "${{ inputs.group_name }}" ]; then
          GROUP_TO_USE=$GROUP_NAME
        else
          GROUP_TO_USE="${{ inputs.group_name }}"
        fi

        RESPONSE=$(curl -s -f -X POST \
          -H "Authorization: Bearer ${{ inputs.api_token }}" \
          "https://api.turso.tech/v1/organizations/${{ inputs.organization_name }}/databases/${{ github.ref_name }}/auth/tokens?expiration=2w&authorization=full-access")

        if [ $? -ne 0 ]; then
          echo "Could not create database"
          exit 1
        fi

        TOKEN=$(echo $RESPONSE | jq -r '.jwt')
        if [ -z "$TOKEN" ]; then
          echo "Token not found in response"
          exit 1
        fi

        echo "token=$TOKEN" >> $GITHUB_OUTPUT
